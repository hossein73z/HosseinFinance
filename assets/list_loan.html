<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لیست وام‌ها</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet"
          type="text/css"/>

    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f9);
            --text-color: var(--tg-theme-text-color, #222);
            --hint-color: var(--tg-theme-hint-color, #999);
            --button-color: var(--tg-theme-button-color, #4a90e2);
            --green-color: #28a745;
            --red-color: #dc3545;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        html, body {
            min-height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--secondary-bg-color);
            color: var(--text-color);
            font-family: 'Vazirmatn', sans-serif;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            padding: 15px;
            padding-bottom: 80px;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h2, h3 {
            margin-top: 0;
            color: var(--text-color);
        }

        /* --- LOAN CARD --- */
        .card {
            background-color: var(--bg-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            position: relative;
        }

        .card:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .card-amount {
            font-weight: 700;
            color: var(--button-color);
            font-size: 1rem;
        }

        .card-details {
            font-size: 0.85rem;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .text-hint {
            color: var(--hint-color);
        }

        .text-danger {
            color: var(--red-color);
        }

        .text-success {
            color: var(--green-color);
        }

        .progress-wrapper {
            height: 6px;
            background-color: var(--secondary-bg-color);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--green-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* --- INSTALLMENT ITEM --- */
        .installment-list {
            background: var(--bg-color);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .installment-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--secondary-bg-color);
        }

        .installment-item:last-child {
            border-bottom: none;
        }

        .inst-index {
            width: 30px;
            color: var(--hint-color);
            font-size: 0.9rem;
        }

        .inst-info {
            flex: 1;
        }

        .inst-date {
            font-weight: bold;
            font-size: 1rem;
            display: block;
        }

        .inst-amount {
            font-size: 0.85rem;
            color: var(--hint-color);
        }

        .inst-action {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--secondary-bg-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        /* Status Styles */
        .installment-item.is-paid .inst-action {
            background-color: var(--green-color);
            color: white;
        }

        .installment-item.is-paid .inst-date {
            color: var(--hint-color);
            text-decoration: line-through;
        }

        /* Error State for Action */
        .inst-action.error {
            border: 2px solid var(--red-color);
        }

        /* --- MINI SPINNER --- */
        .mini-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top: 2px solid var(--button-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Spinner for delete button */
        .btn-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(220, 53, 69, 0.2);
            border-top: 2px solid var(--red-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }

        .installment-item.is-paid .mini-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
        }

        /* --- FAB & HEADER --- */
        .detail-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--button-color);
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            z-index: 99;
        }

        .fab svg {
            width: 28px;
            height: 28px;
            fill: currentColor;
        }

        /* --- LOADING OVERLAY --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease-out;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--secondary-bg-color);
            border-top: 4px solid var(--button-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 15px;
            color: var(--hint-color);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .btn-delete-loan {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: transparent;
            border: 1px solid var(--red-color);
            color: var(--red-color);
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-delete-loan:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">در حال دریافت اطلاعات...</div>
</div>

<div class="container">
    <!-- VIEW 1: LIST -->
    <div id="view-list">
        <h2>لیست وام‌ها</h2>
        <div id="loans-container"></div>
        <div id="empty-state" class="hidden" style="text-align:center; margin-top:50px; color:var(--hint-color);">
            <p>هیچ وامی ثبت نشده است.</p>
        </div>
    </div>

    <!-- VIEW 2: DETAILS -->
    <div id="view-detail" class="hidden">
        <div class="detail-header">
            <div>
                <h3 id="detail-title" style="margin:0">عنوان وام</h3>
                <span id="detail-subtitle" class="text-hint" style="font-size:0.8rem;">جزئیات</span>
            </div>
        </div>

        <div class="card" style="margin-bottom: 20px; cursor: default;">
            <div class="card-details">
                <span>مبلغ کل:</span>
                <span id="detail-total-amount" style="font-weight:bold"></span>
            </div>
            <div class="card-details">
                <span>باقی‌مانده:</span>
                <span id="detail-remaining" class="text-danger" style="font-weight:bold"></span>
            </div>
            <div class="progress-wrapper">
                <div id="detail-progress" class="progress-fill"></div>
            </div>
            <div style="text-align: center; margin-top: 5px; font-size: 0.8rem; color: var(--hint-color);">
                <span id="detail-paid-count">0</span> قسط پرداخت شده
            </div>
        </div>

        <h4>لیست اقساط</h4>
        <div id="installments-container" class="installment-list"></div>

        <button id="btn-delete" class="btn-delete-loan" onclick="deleteCurrentLoan()">حذف کامل این وام</button>
    </div>
</div>

<a href="add_loan.html" class="fab" id="fab-add">
    <svg viewBox="0 0 24 24">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
    </svg>
</a>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- CONFIG ---
    const API_URL = 'https://hossein-finance.vercel.app/api/ExternalConnections/api.php';
    const urlParams = new URLSearchParams(window.location.search);
    const SECRET_KEY = urlParams.get('k');
    const PERSON_ID = urlParams.get('id');

    // Update ADD URL with both Key and Person ID
    if (SECRET_KEY) {
        let addUrl = `add_loan.html?k=${SECRET_KEY}`;
        if (PERSON_ID) addUrl += `&id=${PERSON_ID}`;
        document.getElementById('fab-add').href = addUrl;
    }

    let allLoans = [];
    let currentLoanId = null;

    // --- UTILS ---
    function toPersianDigits(str) {
        if (str == null) return '';
        const id = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        return String(str).replace(/[0-9]/g, w => id[+w]);
    }

    function addCommas(nStr) {
        nStr += '';
        const x = nStr.split('.');
        let x1 = x[0];
        const x2 = x.length > 1 ? '.' + x[1] : '';
        const rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) x1 = x1.replace(rgx, '$1' + ',' + '$2');
        return x1 + x2;
    }

    function showLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loading-overlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loading-overlay').style.display = 'none';
        }, 300);
    }

    async function apiRequest(payload) {
        if (!SECRET_KEY) {
            tg.showAlert('کلید امنیتی یافت نشد.');
            return null;
        }
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'x-api-key': SECRET_KEY},
                body: JSON.stringify(payload)
            });
            return await response.json();
        } catch (error) {
            tg.showAlert('خطا در ارتباط: ' + error.message);
            return null;
        }
    }

    // --- MAIN LOGIC ---

    async function fetchData() {
        if (!PERSON_ID) {
            tg.showAlert("شناسه شخص یافت نشد.");
            return;
        }

        showLoading();
        tg.BackButton.hide();

        // New Payload: Single call for loans + installments
        const payload = {
            "operation": "read",
            "table": "loans",
            "conditions": {
                "person_id": PERSON_ID
            },
            "selectColumns": "loans.*, JSON_ARRAYAGG(JSON_OBJECT('id', installments.id, 'amount', installments.amount, 'due_date', installments.due_date, 'is_paid', installments.is_paid)) as installments",
            "join": "LEFT JOIN installments ON loans.id=installments.loan_id",
            "groupBy": "loans.id"
        };

        const req = await apiRequest(payload);

        if (req && req.data) {
            // Parse the installments string into objects
            allLoans = req.data.map(loan => {
                let parsedInstallments = [];
                try {
                    if (typeof loan.installments === 'string') {
                        parsedInstallments = JSON.parse(loan.installments);
                    } else if (Array.isArray(loan.installments)) {
                        parsedInstallments = loan.installments;
                    }

                    // Handle case where LEFT JOIN returns [null] because there are no installments
                    if (parsedInstallments.length === 1 && parsedInstallments[0].id === null) {
                        parsedInstallments = [];
                    }
                } catch (e) {
                    console.error("Error parsing installments", e);
                    parsedInstallments = [];
                }
                return {...loan, installments: parsedInstallments};
            });
        } else {
            allLoans = [];
        }

        renderLoanList();
        hideLoading();
    }

    function renderLoanList() {
        const container = document.getElementById('loans-container');
        container.innerHTML = '';

        if (allLoans.length === 0) {
            document.getElementById('empty-state').classList.remove('hidden');
        } else {
            document.getElementById('empty-state').classList.add('hidden');
        }

        allLoans.forEach(loan => {
            const loanInstallments = loan.installments || [];

            // Calculate stats based on nested installments
            const paidInst = loanInstallments.filter(i => i.is_paid == 1).length;
            const paidAmount = loanInstallments.filter(i => i.is_paid == 1).reduce((sum, i) => sum + parseFloat(i.amount), 0);

            const totalAmount = parseFloat(loan.total_amount);
            const remaining = totalAmount - paidAmount;
            const progress = totalAmount > 0 ? (paidAmount / totalAmount) * 100 : 0;

            const unpaidInsts = loanInstallments.filter(i => i.is_paid == 0).sort((a, b) => a.due_date.localeCompare(b.due_date));
            let nextDate = unpaidInsts.length > 0 ? unpaidInsts[0].due_date : "تسویه شده";

            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openDetail(loan.id);
            card.innerHTML = `
                <div class="card-header">
                    <span class="card-title">${loan.name}</span>
                    <span class="card-amount">${toPersianDigits(addCommas(totalAmount))} <small>ریال</small></span>
                </div>
                <div class="card-details">
                    <span class="text-hint">قسط بعدی:</span>
                    <span>${toPersianDigits(nextDate)}</span>
                </div>
                <div class="card-details">
                    <span class="text-hint">مانده:</span>
                    <span class="${remaining > 0 ? 'text-danger' : 'text-success'}">${toPersianDigits(addCommas(remaining))}</span>
                </div>
                <div class="progress-wrapper">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function openDetail(loanId) {
        currentLoanId = loanId;
        const loan = allLoans.find(l => l.id == loanId);
        if (!loan) return;

        // Show Back Button inside Telegram
        tg.BackButton.show();

        document.getElementById('view-list').classList.add('hidden');
        document.getElementById('fab-add').classList.add('hidden');
        document.getElementById('view-detail').classList.remove('hidden');
        window.scrollTo(0, 0);

        document.getElementById('detail-title').innerText = loan.name;
        document.getElementById('detail-subtitle').innerText = toPersianDigits(loan.received_date);
        document.getElementById('detail-total-amount').innerText = toPersianDigits(addCommas(loan.total_amount)) + ' ریال';

        // Reset Delete Button State
        const btnDelete = document.getElementById('btn-delete');
        btnDelete.innerHTML = 'حذف کامل این وام';
        btnDelete.disabled = false;

        renderInstallmentsList();
    }

    function renderInstallmentsList() {
        if (!currentLoanId) return;
        const loan = allLoans.find(l => l.id == currentLoanId);
        if (!loan) return;

        const loanInsts = loan.installments || [];
        loanInsts.sort((a, b) => a.due_date.localeCompare(b.due_date));

        const container = document.getElementById('installments-container');
        container.innerHTML = '';

        const totalAmount = parseFloat(loan.total_amount);
        const paidAmount = loanInsts.filter(i => i.is_paid == 1).reduce((sum, i) => sum + parseFloat(i.amount), 0);
        const remaining = totalAmount - paidAmount;
        const progress = totalAmount > 0 ? (paidAmount / totalAmount) * 100 : 0;

        document.getElementById('detail-remaining').innerText = toPersianDigits(addCommas(remaining)) + ' ریال';
        document.getElementById('detail-progress').style.width = `${progress}%`;
        document.getElementById('detail-paid-count').innerText = toPersianDigits(loanInsts.filter(i => i.is_paid == 1).length);

        loanInsts.forEach((inst, index) => {
            const isPaid = inst.is_paid == 1;
            const div = document.createElement('div');
            div.className = `installment-item ${isPaid ? 'is-paid' : ''}`;
            div.id = `row-${inst.id}`;

            // Icon Logic
            const checkIcon = '<svg viewBox="0 0 24 24" fill="white" width="20" height="20"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
            const emptyCircle = '<div style="width:16px; height:16px; border:2px solid var(--hint-color); border-radius:50%"></div>';

            div.innerHTML = `
                <div class="inst-index">${toPersianDigits(index + 1)}</div>
                <div class="inst-info">
                    <span class="inst-date">${toPersianDigits(inst.due_date)}</span>
                    <span class="inst-amount">${toPersianDigits(addCommas(inst.amount))} ریال</span>
                </div>
                <div class="inst-action" id="btn-${inst.id}" onclick="togglePayment(${inst.id}, ${isPaid ? 0 : 1})">
                    ${isPaid ? checkIcon : emptyCircle}
                </div>
            `;
            container.appendChild(div);
        });
    }

    async function togglePayment(instId, newStatus) {
        const btn = document.getElementById(`btn-${instId}`);
        const row = document.getElementById(`row-${instId}`);
        const originalContent = btn.innerHTML;
        const originalClass = row.className;

        // 1. VISUAL LOADING STATE
        btn.innerHTML = '<div class="mini-spinner"></div>';

        // 2. NETWORK REQUEST
        const payload = {
            "operation": "update",
            "table": "installments",
            "data": {"is_paid": newStatus},
            "conditions": {"id": instId}
        };

        const res = await apiRequest(payload);

        if (res && res.success) {
            // 3. SUCCESS
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

            // Update local data inside nested structure
            const loan = allLoans.find(l => l.id == currentLoanId);
            if (loan) {
                const inst = loan.installments.find(i => i.id == instId);
                if (inst) inst.is_paid = newStatus;
            }

            // Re-render whole list to update Progress Bar and Header stats
            renderInstallmentsList();
        } else {
            // 4. ERROR
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');

            // Revert icon
            btn.innerHTML = originalContent;
            row.className = originalClass;

            // Visual Error indicator on the button
            btn.classList.add('error');
            setTimeout(() => btn.classList.remove('error'), 1000);
        }
    }

    function deleteCurrentLoan() {
        tg.showConfirm("آیا از حذف کامل این وام و تمام اقساط آن اطمینان دارید؟", async (confirmed) => {
            if (confirmed) {
                // Show Small Loading Indicator on Button
                const btnDelete = document.getElementById('btn-delete');
                const originalText = btnDelete.innerText;
                btnDelete.innerHTML = '<div class="btn-spinner"></div>';
                btnDelete.disabled = true;

                const payload = {
                    "operation": "delete",
                    "table": "loans",
                    "conditions": {"id": currentLoanId}
                };

                const res = await apiRequest(payload);

                if (res && res.success) {
                    allLoans = allLoans.filter(l => l.id != currentLoanId);
                    goBack();
                } else {
                    tg.showAlert('خطا در حذف وام');
                    // Restore button state on error
                    btnDelete.innerHTML = originalText;
                    btnDelete.disabled = false;
                }
            }
        });
    }

    function goBack() {
        currentLoanId = null;
        tg.BackButton.hide(); // Hide button when returning to list
        document.getElementById('view-detail').classList.add('hidden');
        document.getElementById('view-list').classList.remove('hidden');
        document.getElementById('fab-add').classList.remove('hidden');
        renderLoanList();
    }

    // Initialize Back Button behavior for this specific file
    tg.BackButton.onClick(goBack);

    document.addEventListener('DOMContentLoaded', fetchData);
</script>
</body>
</html>